name: Publish @dika.sui/sdk

on:
  workflow_dispatch: {} # manual trigger

permissions:
  contents: read

env:
  RUSTDOCFLAGS: -Dwarnings
  RUST_BACKTRACE: 1
  rust_stable: 1.90
  SUI_VERSION: "sui@mainnet"

jobs:
  publish-sdk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Install Rust ${{ env.rust_stable }}
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.rust_stable }}

      - name: Install wasm-pack
        run: |
          curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
          wasm-pack --version

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Update npm to latest
        run: npm install -g npm@latest

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install Sui CLI via suiup
        run: |
          curl -sSfL https://raw.githubusercontent.com/MystenLabs/suiup/main/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          export PATH="$HOME/.local/bin:$PATH"
          "$HOME/.local/bin/suiup" install "$SUI_VERSION" -y
          sui --version

      - name: Install dependencies (workspace)
        run: pnpm install --frozen-lockfile

      - name: Get package info
        id: pkg
        working-directory: ./sdk/typescript
        run: |
          NAME=$(node -p "require('./package.json').name")
          VERSION=$(node -p "require('./package.json').version")
          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Package: $NAME@$VERSION"

      - name: Check if already published
        id: check
        env:
          PKG_NAME: ${{ steps.pkg.outputs.name }}
          PKG_VERSION: ${{ steps.pkg.outputs.version }}
        run: |
          if npm view "$PKG_NAME@$PKG_VERSION" version > /dev/null 2>&1; then
            echo "published=true" >> "$GITHUB_OUTPUT"
            echo "$PKG_NAME@$PKG_VERSION is already published. Skipping."
          else
            echo "published=false" >> "$GITHUB_OUTPUT"
            echo "$PKG_NAME@$PKG_VERSION not yet published. Will publish."
          fi

      - name: Build
        working-directory: ./sdk/typescript
        run: pnpm build

      - name: Publish
        if: steps.check.outputs.published == 'false'
        working-directory: ./sdk/typescript
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
        run: |
          pnpm publish --no-git-checks --access public
          echo "Published ${{ steps.pkg.outputs.name }}@${{ steps.pkg.outputs.version }}"
